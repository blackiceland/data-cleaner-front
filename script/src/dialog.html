<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="https://cdn.tailwindcss.com/3.4.4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Noto Sans', ui-sans-serif, sans-serif
        }

        .panel {
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
            border-radius: 8px
        }

        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(8px)
            }
            to {
                opacity: 1;
                transform: none
            }
        }

        .fade-in {
            animation: fade 120ms cubic-bezier(.2, 0, .38, .9) forwards
        }
    </style>
</head>
<body class="fade-in">
<div class="h-full flex flex-col">
    <div class="panel relative bg-white/90 backdrop-blur flex-auto m-0 p-6 overflow-auto">
        <!-- Header removed as requested -->

        <p id="meter" class="text-sm text-gray-600 mb-4">
            <span class="font-semibold">Duplicates:</span> <span id="dupPct">–</span>,
            <span class="font-semibold">Blanks:</span> <span id="blankPct">–</span>,
            <span class="font-semibold">Weird dates:</span> <span id="datePct">–</span>
        </p>

        <!-- Range input + Scan button -->
        <div class="flex items-center gap-3 mb-3">
            <input id="rangeInput" type="text"
                   class="flex-auto border border-gray-300 rounded px-3 py-2 text-sm
                          focus:outline-none focus:ring-1 focus:ring-[#00B8D9]"
                   placeholder="Select range…">
            <button id="scanBtn"
                    class="px-5 py-2 rounded text-white font-semibold
                           bg-[#00B8D9] hover:bg-[#00a4c2] disabled:opacity-50">
                Scan
            </button>
        </div>
        <!-- Action dropdown -->
        <select id="actionSel"
                class="w-full mb-4 border border-gray-300 rounded px-3 py-2 text-sm
                       focus:outline-none focus:ring-1 focus:ring-[#00B8D9]">
            <option value="HIGHLIGHT" selected>Highlight duplicates</option>
            <option value="DELETE">Delete duplicates</option>
            <option value="MOVE">Move duplicates</option>
            <option value="MARK">Mark duplicates</option>
        </select>

        <!-- Options -->
        <div class="flex flex-col gap-2 mb-6">
            <label class="flex items-center gap-2">
                <input id="hdrChk" type="checkbox"
                       class="w-5 h-5 rounded focus:ring-2 focus:ring-[#00B8D9]" checked>
                <span class="text-sm">My range has headers</span>
            </label>
        </div>

        <!-- Spinner -->
        <div id="spinner" class="hidden absolute inset-0 flex items-center justify-center bg-white/70">
            <svg class="animate-spin h-16 w-16 text-[#00B8D9]" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
        </div>

        <!-- Results -->
        <section id="results" class="space-y-8 hidden">
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Exact duplicates</h3>
                <div id="exactPanel"
                     class="min-h-[80px] border border-gray-200 rounded-md
                            flex items-center justify-center text-gray-400">
                    No data yet
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Possible duplicates</h3>
                <div id="fuzzyPanel"
                     class="min-h-[80px] border border-gray-200 rounded-md
                            flex items-center justify-center text-gray-400">
                    No data yet
                </div>
            </div>
        </section>
    </div>

    <footer id="statusBar"
            class="text-sm text-center text-gray-600 py-2 border-t border-gray-200">
        Ready.
    </footer>
</div>

<script>
    /* element refs */
    const scanBtn = document.getElementById('scanBtn');
    const rangeInput = document.getElementById('rangeInput');
    const hdrChk = document.getElementById('hdrChk');
    const results = document.getElementById('results');
    const spinner = document.getElementById('spinner');
    const setStatus = msg => document.getElementById('statusBar').textContent = msg;
    const fillMeter = (d = 0, b = 0, w = 0) => {
        dupPct.textContent = d + ' %';
        blankPct.textContent = b + ' %';
        datePct.textContent = w + ' %';
    };

    /* initial range */
    google.script.run
        .withFailureHandler(() => setStatus('Failed to get initial range'))
        .withSuccessHandler(a1 => {
            rangeInput.value = a1;
        })
        .getInitialRangeA1();

    /* auto-update range when user changes selection */
    let lastA1 = '';
    setInterval(() => {
        google.script.run
            .withSuccessHandler(a1 => {
                if (a1 && a1 !== lastA1 && !rangeInput.dataset.manual) {
                    lastA1 = a1;
                    rangeInput.value = a1;
                }
            })
            .withFailureHandler(() => {
            })
            .getActiveRangeA1();
    }, 400);
    rangeInput.addEventListener('input', () => {
        rangeInput.dataset.manual = true;
    });
    rangeInput.addEventListener('blur', () => {
        delete rangeInput.dataset.manual;
    });

    const setScanning = on => {
        scanBtn.disabled = on;
        spinner.classList.toggle('hidden', !on);
    };

    /* Scan */
    scanBtn.addEventListener('click', () => {
        setScanning(true);
        setStatus('Scanning…');

        google.script.run
            .withSuccessHandler(rows => {
                fillMeter(26, 8, 2);
                google.script.run
                    .withSuccessHandler(async token => {
                        try {
                            const res = await fetch(
                                'https://cleaner-132616592036.us-central1.run.app/api/v1/sheets/duplicates',
                                {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                                    body: JSON.stringify({rows, hasHeaders: hdrChk.checked})
                                });
                            if (!res.ok) throw new Error('API ' + res.status);
                            const data = await res.json();
                            exactPanel.textContent = data.exact?.length ? `${data.exact.length} groups` : 'No exact duplicates';
                            fuzzyPanel.textContent = data.maybe?.length ? `${data.maybe.length} groups` : 'No possible duplicates';
                            results.classList.remove('hidden');
                            setStatus('Scan complete.');
                        } catch (e) {
                            exactPanel.textContent = 'Error: ' + e.message;
                            setStatus('Failed — see console');
                        } finally {
                            setScanning(false);
                        }  // hide spinner
                    })
                    .withFailureHandler(err => {
                        setStatus('Token error: ' + err);
                        setScanning(false);
                    })
                    .getIdToken();
            })
            .withFailureHandler(err => {
                setStatus('Range error: ' + err);
                setScanning(false);
            })
            .getActiveRangeValues();
    });

    /* Esc closes */
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            google.script.host.close();
        }
    });
</script>
</body>
</html>
