<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>DataCleaner</title>
    <script src="https://cdn.tailwindcss.com/3.4.4"></script>
    <style>
        body {
            margin: 0;
            font-family: ui-sans-serif, 'Noto Sans', sans-serif
        }

        #card {
            box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
            cursor: move
        }
    </style>
</head>

<body>
<div id="card" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[560px]
                     bg-white/90 backdrop-blur rounded-xl p-6 flex flex-col gap-4">
    <h2 class="text-xl font-semibold text-center">DataCleaner</h2>

    <button id="btn" class="w-full px-4 py-2 rounded bg-cyan-500 text-white disabled:opacity-50" disabled>
        Clean duplicates
    </button>

    <div id="status" class="min-h-[1.5rem] text-sm text-center break-all"></div>
</div>

<script>
    ((el) => {
        let sx = 0, sy = 0;
        el.addEventListener('pointerdown', e => {
            if (e.target.tagName === 'BUTTON') return;
            sx = e.clientX - el.offsetLeft;
            sy = e.clientY - el.offsetTop;
            const mv = ev => {
                el.style.left = (ev.clientX - sx) + 'px';
                el.style.top = (ev.clientY - sy) + 'px';
            };
            const up = () => window.removeEventListener('pointermove', mv);
            window.addEventListener('pointermove', mv);
            window.addEventListener('pointerup', up, {once: true});
        })
    })(document.getElementById('card'));

    const API_BASE = 'https://cleaner-132616592036.us-central1.run.app/api/v1';
    const btn = document.getElementById('btn');
    const status = m => (document.getElementById('status').textContent = m);

    async function getToken() {
        return new Promise(r => google.script.run.withSuccessHandler(r).getIdToken());
    }

    async function callApi(rows) {
        const token = await getToken();
        const res = await fetch(`${API_BASE}/sheets/duplicates`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify({rows})
        });
        if (res.status === 401) return callApi(rows);
        if (!res.ok) throw new Error(res.status);
        return res.json();
    }

    window.addEventListener('DOMContentLoaded', () => {
        btn.disabled = false;
        btn.onclick = () => {
            btn.disabled = true;
            status('Fetching range…');
            google.script.run.withSuccessHandler(async rows => {
                try {
                    status(`Rows: ${rows.length} • contacting API…`);
                    const {confirmed = [], candidates = []} = await callApi(rows);
                    status(`Exact: ${confirmed.length} • Possible: ${candidates.length}`);
                    const dup = [...new Set(confirmed.flat())];
                    if (dup.length) google.script.run.highlightExactRows(dup);
                } catch (e) {
                    status(e.message);
                } finally {
                    btn.disabled = false;
                }
            }).getActiveRangeValues();
        };
    });
</script>
</body>
</html>
